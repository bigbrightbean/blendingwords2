<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Short Vowel A</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h1>Short Vowel <span class="vowel">A</span></h1>

  <!-- ================= SOUND MODE TOGGLE ================= -->
  <div class="sound-toggle">
    <button class="generate-btn" data-gen="2">Generate 2s</button>
    <button class="sound-btn" data-mode="2">2 sounds</button>
    <button class="sound-btn active" data-mode="3">3 sounds</button>
    <button class="generate-btn" data-gen="3">Generate 3s</button>
  </div>

  <!-- ================= TABS ================= -->
  <div class="tabs">
    <button class="tab active" data-family="at">-at</button>
    <button class="tab" data-family="an">-an</button>
    <button class="tab" data-family="am">-am</button>
    <button class="tab" data-family="ap">-ap</button>
    <button class="tab" data-family="ag">-ag</button>
    <button class="tab" data-family="ab">-ab</button>
    <button class="tab" data-family="as">-as</button>
    <button class="tab" data-family="ax">-ax</button>
    <button class="tab" data-family="azz">-azz</button>
    <button class="tab" data-family="ack">-ak / -ack</button>
  </div>

  <!-- ================= GENERATED WORDS ================= -->
  <div class="generated-scale">
    <div id="generated-area" class="generated-area"></div>
  </div>

  <!-- ================= -AT ================= -->
  <section class="family active" data-family="at">
    <ul class="word-container">
      <li>cat</li>
      <li>bat</li>
      <li>rat</li>
      <li>hat</li>
      <li>mat</li>
      <li>fat</li>
      <li>pat</li>
      <li>sat</li>
    </ul>
  </section>

  <!-- ================= -AN ================= -->
  <section class="family" data-family="an">
    <ul class="word-container">
      <li>ban</li>
      <li>can</li>
      <li>fan</li>
      <li>man</li>
      <li>pan</li>
      <li>ran</li>
      <li>tan</li>
      <li>van</li>
    </ul>
  </section>

  <!-- ================= -AM ================= -->
  <section class="family" data-family="am">
    <ul class="word-container">
      <li>jam</li>
      <li>ham</li>
      <li>ram</li>
      <li>dam</li>
      <li>yam</li>
      <li>Pam</li>
    </ul>
  </section>

  <!-- ================= -AP ================= -->
  <section class="family" data-family="ap">
    <ul class="word-container">
      <li>map</li>
      <li>cap</li>
      <li>tap</li>
      <li>lap</li>
      <li>nap</li>
      <li>gap</li>
      <li>sap</li>
      <li>zap</li>
    </ul>
  </section>

  <!-- ================= -AG ================= -->
  <section class="family" data-family="ag">
    <ul class="word-container">
      <li>bag</li>
      <li>rag</li>
      <li>tag</li>
      <li>wag</li>
      <li>nag</li>
      <li>lag</li>
      <li>sag</li>
    </ul>
  </section>

  <!-- ================= -AB ================= -->
  <section class="family" data-family="ab">
    <ul class="word-container">
      <li>cab</li>
      <li>lab</li>
      <li>jab</li>
      <li>dab</li>
      <li>nab</li>
      <li>tab</li>
    </ul>
  </section>

  <!-- ================= -AS ================= -->
  <section class="family" data-family="as">
    <ul class="word-container">
      <li>gas</li>
      <li>has</li>
    </ul>
  </section>

  <!-- ================= -AX ================= -->
  <section class="family" data-family="ax">
    <ul class="word-container">
      <li>fax</li>
      <li>tax</li>
      <li>wax</li>
    </ul>
  </section>

  <!-- ================= -AZZ ================= -->
  <section class="family" data-family="azz">
    <ul class="word-container">
      <li>jazz</li>
    </ul>
  </section>

  <!-- ================= -AK / -ACK ================= -->
  <section class="family" data-family="ack">
    <ul class="word-container">
      <li>yak</li>
      <li>back</li>
      <li>pack</li>
      <li>lack</li>
    </ul>
  </section>

  <a href="index.html" class="back-btn">‚Üê Back to Home</a>

  <script>
    const targetVowel = 'a';
    const digraphEndings = ['ll','ff','ss','zz','sh','ch','ck','ng','th'];
    let soundMode = '3'; // default

    /* ======================================================
       AUDIO SETUP
       ====================================================== */

    const AUDIO_BASE_PATH = 'audio/short-a/';
    const TEST_AUDIO_FILE = 'test.m4a';

    const wordAudio = new Audio();
    wordAudio.preload = 'auto';

    function playTestAudio() {
      wordAudio.onerror = null;
      wordAudio.src = AUDIO_BASE_PATH + TEST_AUDIO_FILE;
      wordAudio.currentTime = 0;
      wordAudio.play().catch(() => {});
    }

    function playWordAudio(word) {
      const suffix = soundMode === '2' ? '2s' : '3s';
      const audioPath = AUDIO_BASE_PATH + word + suffix + '.m4a';

      wordAudio.onerror = () => {
        playTestAudio();
      };

      wordAudio.src = audioPath;
      wordAudio.currentTime = 0;
      wordAudio.play().catch(() => {});
    }

    /* ======================================================
       SCALE GENERATED GRID (FIXED LAYOUT, AUTO FIT)
       ====================================================== */

    function scaleGeneratedGrid() {
      const scaleWrapper = document.querySelector('.generated-scale');
      const grid = document.querySelector('.generated-area');
      if (!scaleWrapper || !grid) return;

      const availableWidth = scaleWrapper.clientWidth;
      const gridWidth = grid.scrollWidth;

      const scale = Math.min(1, availableWidth / gridWidth);
      grid.style.transform = `scale(${scale})`;
    }

    window.addEventListener('resize', scaleGeneratedGrid);

    /* ======================================================
       RENDER WORDS
       ====================================================== */

    function renderWords() {
      document.querySelectorAll('.word-container li').forEach(li => {
        const word = li.dataset.word || li.textContent.trim().toLowerCase();
        li.dataset.word = word;

        /* ----- wrap word + speaker button ONCE ----- */
        if (!li.closest('.word-wrapper')) {
          const wrapper = document.createElement('div');
          wrapper.className = 'word-wrapper';

          const speakerBtn = document.createElement('button');
          speakerBtn.className = 'speaker-btn';
          speakerBtn.innerHTML = 'üîä';

          speakerBtn.onclick = (e) => {
            e.stopPropagation();
            playWordAudio(word);
          };

          li.parentNode.insertBefore(wrapper, li);
          wrapper.appendChild(li);
          wrapper.appendChild(speakerBtn);
        }

        li.innerHTML = '';

        if (soundMode === '2') {
          const first = word[0];
          const ending = word.slice(1);

          const cSpan = document.createElement('span');
          cSpan.textContent = first;
          li.appendChild(cSpan);

          const endSpan = document.createElement('span');
          endSpan.textContent = ending;
          endSpan.classList.add('two-sound');
          li.appendChild(endSpan);

        } else {
          let i = 0;
          while (i < word.length) {
            let matched = false;

            for (const d of digraphEndings) {
              if (word.slice(i).startsWith(d)) {
                const span = document.createElement('span');
                span.textContent = d;
                span.classList.add('digraph');
                if (d === 'ng') span.classList.add('ng');
                li.appendChild(span);
                i += d.length;
                matched = true;
                break;
              }
            }

            if (!matched) {
              const letter = word[i];
              const span = document.createElement('span');
              span.textContent = letter;
              if (letter === targetVowel) span.classList.add('vowel');
              li.appendChild(span);
              i++;
            }
          }
        }

        li.onclick = () => {
          li.classList.toggle('selected');
          li.classList.remove('shake');
          void li.offsetWidth;
          li.classList.add('shake');
        };
      });
    }

    /* ======================================================
       EXIT GENERATE MODE
       ====================================================== */

    function exitGenerateMode() {
      document.body.classList.remove('generate-mode');

      const generatedArea = document.getElementById('generated-area');
      if (generatedArea) generatedArea.innerHTML = '';

      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.family').forEach(f => f.classList.remove('active'));

      document.querySelector('.tab')?.classList.add('active');
      document.querySelector('.family')?.classList.add('active');
    }

    /* ======================================================
       SOUND BUTTONS
       ====================================================== */

    document.querySelectorAll('.sound-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        exitGenerateMode();

        document.querySelectorAll('.sound-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        soundMode = btn.dataset.mode;

        renderWords();
      });
    });

    /* ======================================================
       TABS
       ====================================================== */

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        if (document.body.classList.contains('generate-mode')) {
          tab.classList.toggle('active');
          return;
        }

        const family = tab.dataset.family;

        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.family').forEach(f => f.classList.remove('active'));

        tab.classList.add('active');
        document.querySelector(`.family[data-family="${family}"]`).classList.add('active');
      });
    });

    /* ======================================================
       GENERATE 2s / 3s
       ====================================================== */

    const generatedArea = document.getElementById('generated-area');

    document.querySelectorAll('.generate-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const genMode = btn.dataset.gen;

        document.body.classList.add('generate-mode');
        soundMode = genMode;

        document.querySelectorAll('.sound-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.sound-btn[data-mode="${genMode}"]`)?.classList.add('active');

        document.querySelectorAll('.tab').forEach(t => t.classList.add('active'));

        generatedArea.innerHTML = '';

        let allWords = [];
        document.querySelectorAll('.family').forEach(section => {
          allWords.push(
            ...Array.from(section.querySelectorAll('li'))
              .map(li => li.dataset.word || li.textContent.trim().toLowerCase())
          );
        });

        const COLS = 3;
        const ROWS = 2;
        const TOTAL = COLS * ROWS;

        const shuffled = [...allWords].sort(() => 0.5 - Math.random());
        const selected = shuffled.slice(0, TOTAL);

        selected.forEach(word => {
          const ul = document.createElement('ul');
          ul.className = 'word-container';

          const li = document.createElement('li');
          li.textContent = word;

          ul.appendChild(li);
          generatedArea.appendChild(ul);
        });

        renderWords();
        scaleGeneratedGrid(); // üîë auto-fit after generate
      });
    });

    /* ======================================================
       INITIAL RENDER
       ====================================================== */

    renderWords();
  </script>

</body>
</html>